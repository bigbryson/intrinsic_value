{% extends "layout/layout_vertical.html" %}
{% load static %}

{% block title %}Dashboard{% endblock title %}

{% block content %}

{# This block will only show if the user has NOT connected an account #}
{% if show_connection_modal %}
<div class="card mb-4">
  <div class="card-body text-center">
    <h4 class="card-title">Welcome to Your Portfolio!</h4>
    <p class="card-text">To see your holdings and transactions, please connect your financial accounts.</p>

    {# This button will launch the Yodlee FastLink UI #}
    <button id="connect-account-btn" class="btn btn-primary">
      Connect an Account
    </button>
  </div>
</div>
{# This is the container that Yodlee's script will use to render its UI #}
<div id="fastlink-container"></div>
{% endif %}


<div class="row gy-6">
  {# This is the main content of your dashboard, which will be more useful #}
  {# once the user has connected their accounts. #}
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title m-0 me-2">Portfolio Overview</h5>
      </div>
      <div class="card-body">
        <p>Your portfolio data will appear here once you connect an account.</p>
      </div>
    </div>
  </div>
</div>
{% endblock content %}


{% block page_js %}
{{ block.super }}

{# Yodlee FastLink library script #}
<script src="https://cdn.yodlee.com/fastlink/v4/initialize.js"></script>

{# Yodlee FastLink Launch Script #}
<script>
  // Wait until the entire HTML document is loaded and ready
  document.addEventListener('DOMContentLoaded', function () {
    // Check if the connect button exists on the page
    const connectBtn = document.getElementById('connect-account-btn');
    if (connectBtn) {
      connectBtn.addEventListener('click', function() {
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        this.disabled = true;

        // Fetch our FastLink token from the backend
        fetch("{% url 'connection_page:yodlee_launch_fastlink' %}")
          .then(response => response.json())
          .then(data => {
            if (data.fastlink_token) {
              // Launch Yodlee FastLink
              window.fastlink.open({
                fastLinkURL: "https://fl4.sandbox.yodlee.com/authenticate/restserver/fastlink",
                accessToken: `Bearer ${data.fastlink_token}`,
                params: {
                  configName: 'Verification'
                },
                onSuccess: function (data) {
                  // After success, tell our server and redirect to the holdings page
                  fetch("{% url 'connection_page:yodlee_success_callback' %}")
                    .then(() => window.location.href = "{% url 'holdings:holdings_list' %}");
                },
                onError: function (data) {
                  console.error('FastLink Error:', data);
                  connectBtn.innerHTML = 'Connect an Account';
                  connectBtn.disabled = false;
                },
                onClose: function (data) {
                  console.log('FastLink Closed:', data);
                  connectBtn.innerHTML = 'Connect an Account';
                  connectBtn.disabled = false;
                }
              }, 'fastlink-container');
            } else {
              alert('Failed to get token: ' + (data.error || 'Unknown error'));
              connectBtn.innerHTML = 'Connect an Account';
              connectBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Fetch Error:', error);
            alert('Could not contact the server. Check the browser console for details.');
            connectBtn.innerHTML = 'Connect an Account';
            connectBtn.disabled = false;
          });
      });
    }
  });
</script>
{% endblock page_js %}
