{% extends layout_path %}
{% load static %}
{% load i18n %}
{% load app_filters %}

{% block title %}Portfolio Dashboard{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
{# You will update this JS file later to power all the charts #}
<script src="{% static 'js/dashboards-portfolio.js' %}"></script>
{% endblock page_js %}

{% block content %}
  <!--/ All Holdings  -->

  <div class="col-12">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title m-0">Charles Schwab Holdings</h5>
        </div>
        <div class="card-body">
            <div class="row g-6">
                <!-- Donut Chart -->
                <div class="col-md-5 d-flex align-items-center">
                    <div id="all-holdings-donut-chart" class="w-100"></div>
                </div>
                <!-- Holdings List -->
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th class="text-truncate">Symbol</th>
              <th class="text-truncate">Description</th>
              <th class="text-truncate">Qty</th>
              <th class="text-truncate">Avg. Price</th>
              <th class="text-truncate">Current Price</th>
              <th class="text-truncate">Day Change %</th>
              <th class="text-truncate">Total Gain %</th>
              <th class="text-truncate">Mkt Value</th>
              <th class="text-truncate">Cost Basis</th>
              <th class="text-truncate">Total Gain/Loss</th>
            </tr>
          </thead>
              <tbody>
                {% if schwab_holdings and schwab_holdings.securitiesAccount.positions %}
                  {% for position in schwab_holdings.securitiesAccount.positions %}
                    <tr>
                      <td class="text-truncate">{{ position.instrument.symbol }}</td>
                      <td class="text-truncate">{{ position.instrument.description }}</td>
                      <td class="text-truncate">{{ position.longQuantity|floatformat:2 }}</td>
                      <td class="text-truncate">${{ position.averagePrice|floatformat:2 }}</td>
                      <td class="text-truncate">${{ position.marketValue|div:position.longQuantity|floatformat:2 }}</td>

                      <td>
                        {% if position.currentDayProfitLoss > 0 %}
                          <span class="badge bg-label-success rounded-pill">+${{ position.currentDayProfitLoss|floatformat:2 }}</span>
                        {% else %}
                          <span class="badge bg-label-danger rounded-pill">${{ position.currentDayProfitLoss|floatformat:2 }}</span>
                        {% endif %}
                      </td>

                      <td>
                        {% if position.currentDayProfitLossPercentage > 0 %}
                          <span class="badge bg-label-success rounded-pill">+{{ position.currentDayProfitLossPercentage|floatformat:2 }}%</span>
                        {% else %}
                          <span class="badge bg-label-danger rounded-pill">{{ position.currentDayProfitLossPercentage|floatformat:2 }}%</span>
                        {% endif %}
                      </td>

                      <td class="text-truncate">${{ position.marketValue|floatformat:2 }}</td>

                      {# Cost Basis (Calculated) and Total Gain/Loss #}
                      {% with cost_basis=position.averagePrice|mul:position.longQuantity %}
                        <td class="text-truncate">${{ cost_basis|floatformat:2 }}</td>

                        {% with total_gain_loss=position.marketValue|sub:cost_basis %}
                          {% if total_gain_loss > 0 %}
                            <td class="text-success">+${{ total_gain_loss|floatformat:2 }}</td>
                          {% else %}
                            <td class="text-danger">${{ total_gain_loss|floatformat:2 }}</td>
                          {% endif %}
                        {% endwith %}
                      {% endwith %}
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="10" class="text-center">No holdings found. Please connect to Charles Schwab.</td>
                  </tr>
                {% endif %}
              </tbody>
           <!-- Add more placeholder rows as above in TD needed -->
        </table>
      </div>
            </div>
        </div>
    </div>
  </div>

{% endblock %}
